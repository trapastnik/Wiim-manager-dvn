# –ê–Ω–∞–ª–∏–∑ WiiM Mini API –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞

**–î–∞—Ç–∞:** 2025-12-21

---

## üéØ –¶–ï–õ–¨

–í—ã—è—Å–Ω–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è WiiM Mini —Å –º–µ–Ω—å—à–µ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –ø—Ä–∏ —ç—Ç–æ–º –æ–±–Ω–æ–≤–ª—è—è –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Å–µ–∫—É–Ω–¥–Ω–æ (–∫–∞–∫ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏).

---

## üìã –î–û–°–¢–£–ü–ù–´–ï API –ö–û–ú–ê–ù–î–´

### 1. `getPlayerStatus` - –ë–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**Endpoint:** `/httpapi.asp?command=getPlayerStatus`

**–ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `status` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ (play/pause/stop)
- `type` - —Ç–∏–ø –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- `ch` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤
- `mode` - —Ä–µ–∂–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- `loop` - —Ä–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞
- `eq` - —ç–∫–≤–∞–ª–∞–π–∑–µ—Ä
- `curpos` - **—Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è —Ç—Ä–µ–∫–∞ (—Å–µ–∫—É–Ω–¥—ã)**
- `totlen` - –æ–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫—É–Ω–¥—ã)
- `Title` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ (hex-encoded)
- `Artist` - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (hex-encoded)
- `Album` - –∞–ª—å–±–æ–º (hex-encoded)
- `vol` - –≥—Ä–æ–º–∫–æ—Å—Ç—å (0-100)
- `mute` - mute —Å—Ç–∞—Ç—É—Å (0/1)

**–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:** ~500-800 –±–∞–π—Ç (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)

---

### 2. `getStatusEx` - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å

**Endpoint:** `/httpapi.asp?command=getStatusEx`

**–ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –í–°–Å –∏–∑ `getPlayerStatus` +
- `DeviceName` - –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `essid` - –∏–º—è Wi-Fi —Å–µ—Ç–∏ (hex-encoded)
- `ssid` - SSID —Å–µ—Ç–∏
- `rssi` - —É—Ä–æ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª–∞ Wi-Fi
- `bssid` - MAC –∞–¥—Ä–µ—Å —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞
- `battery` - –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏
- `firmware` - –≤–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏
- `project` - –º–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `language` - —è–∑—ã–∫
- `timezone` - —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
- `logoURL` - URL –ª–æ–≥–æ—Ç–∏–ø–∞
- `VersionUpdate` - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ò –µ—â—ë ~80+ –ø–æ–ª–µ–π —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

**–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:** ~3-5 KB

---

## üîç –¢–ï–ö–£–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

### –ß—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å:

```javascript
// Frontend: /api/players/:playerId/status
export async function getPlayerStatus(playerId) {
  return await get(`/api/players/${playerId}/status`);
}
```

### Backend –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:

```javascript
// src/controllers/players.controller.js:69-78
export async function getPlayerStatus(req, res, wiimClient) {
  const { ip } = req.params;
  const status = await wiimClient.getPlayerStatus(ip);  // ‚Üê –ë–∞–∑–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
  res.json(status);
}
```

### WiiM Client:

```javascript
// wiim-client.js:59-65
async getPlayerStatus() {
  return await this.request('/httpapi.asp?command=getPlayerStatus');
}
```

**–í—ã–≤–æ–¥:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–±–∞–∑–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞** `getPlayerStatus` ‚úÖ

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –ö–û–ú–ê–ù–î

| –ü–∞—Ä–∞–º–µ—Ç—Ä | getPlayerStatus | getStatusEx |
|----------|-----------------|-------------|
| **–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞** | ~500-800 –±–∞–π—Ç | ~3-5 KB |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ë—ã—Å—Ç—Ä–µ–µ | –ú–µ–¥–ª–µ–Ω–Ω–µ–µ |
| **–î–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–∫–µ** | ‚úÖ –ï—Å—Ç—å | ‚úÖ –ï—Å—Ç—å |
| **–ü–æ–∑–∏—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è** | ‚úÖ –ï—Å—Ç—å (`curpos`) | ‚úÖ –ï—Å—Ç—å |
| **–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| **Wi-Fi –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |

---

## üöÄ –û–§–ò–¶–ò–ê–õ–¨–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï WIIM

–°–æ–≥–ª–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é community-–ø—Ä–æ–µ–∫—Ç–æ–≤:

### Java API (wiim-java-api)
```
Polling interval: 1000ms (1 —Å–µ–∫—É–Ω–¥–∞) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ:
- –û–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `getPlayerStatus` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Ç—Ä–µ–∫–∞
- –ü–æ–ª–µ `curpos` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º

---

## üí° –í–û–ó–ú–û–ñ–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### ‚ùå 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–ª–µ–≥—á—ë–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É
**–°—Ç–∞—Ç—É—Å:** –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ–±–ª–µ–≥—á—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ API

WiiM HTTP API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É —Ç–∏–ø–∞ `getPlaybackPosition` –∏–ª–∏ `getSimpleStatus`.
–î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ:
- `getPlayerStatus` - —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚úÖ
- `getStatusEx` - –±–æ–ª–µ–µ —Ç—è–∂—ë–ª–∞—è (–≤ 5-7 —Ä–∞–∑ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö)

---

### ‚ùå 2. WebSocket / Server-Sent Events
**–°—Ç–∞—Ç—É—Å:** –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è WiiM —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

WiiM Mini –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- WebSocket connections
- Server-Sent Events (SSE)
- Push notifications

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: **HTTP polling**

---

### ‚ö†Ô∏è 3. –£–º–Ω—ã–π polling (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```javascript
// refresh-service.js:28-29
const interval = isPlaying ? 2000 : 10000;
```

**–í–æ–∑–º–æ–∂–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
```javascript
// –ë–æ–ª–µ–µ —á–∞—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∏–¥—ë—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
const interval = isPlaying ? 1000 : 20000;  // 1 —Å–µ–∫ / 20 —Å–µ–∫
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
- –ü–æ–ª–µ `curpos` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
- –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª 1 —Å–µ–∫

**–ù–∞–≥—Ä—É–∑–∫–∞:**
- 5 –ø–ª–µ–µ—Ä–æ–≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç: 18,000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å (–≤–º–µ—Å—Ç–æ 9,000)
- 10 –ø–ª–µ–µ—Ä–æ–≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç: 36,000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å

**–ü–æ–ª—å–∑–∞:**
- ‚úÖ –ü–æ—Å–µ–∫—É–Ω–¥–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–∫–∞–∫ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
- ‚úÖ –¢–æ—á–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏

---

### ‚úÖ 4. Batching –∑–∞–ø—Ä–æ—Å–æ–≤ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞)

**–ò–¥–µ—è:** –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–µ–µ—Ä–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** WiiM HTTP API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç batch-–∑–∞–ø—Ä–æ—Å—ã

–ö–∞–∂–¥—ã–π –ø–ª–µ–µ—Ä –∏–º–µ–µ—Ç —Å–≤–æ–π IP –∞–¥—Ä–µ—Å:
```
Player 1: 192.168.1.101
Player 2: 192.168.1.102
Player 3: 192.168.1.103
```

–ù—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞–∂–¥—ã–π IP.

---

### ‚úÖ 5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ö–∞–∂–¥—ã–π frontend-–∑–∞–ø—Ä–æ—Å ‚Üí HTTP –∑–∞–ø—Ä–æ—Å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
```javascript
// –ö—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤ —Å TTL 500ms
const statusCache = new Map();

async function getPlayerStatus(ip) {
  const cached = statusCache.get(ip);
  if (cached && Date.now() - cached.time < 500) {
    return cached.data;
  }

  const status = await wiimClient.getPlayerStatus(ip);
  statusCache.set(ip, { data: status, time: Date.now() });
  return status;
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ù–µ—Å–∫–æ–ª—å–∫–æ frontend-–∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 500ms ‚Üí –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–ª–µ–µ—Ä–æ–≤
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI

---

### ‚úÖ 6. Client-side –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏

**–ò–¥–µ—è:** –û–±–Ω–æ–≤–ª—è—Ç—å `curpos` –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

```javascript
// –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ
let lastPosition = 0;
let lastUpdate = Date.now();

// –ö–∞–∂–¥—ã–µ 100ms –æ–±–Ω–æ–≤–ª—è–µ–º UI
setInterval(() => {
  if (isPlaying) {
    const elapsed = (Date.now() - lastUpdate) / 1000;
    currentPosition = lastPosition + elapsed;
    updateProgressBar(currentPosition);
  }
}, 100);

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
function onStatusUpdate(status) {
  lastPosition = status.curpos;
  lastUpdate = Date.now();
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –ü–ª–∞–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –±–µ–∑ –¥—ë—Ä–≥–∞–Ω–∏—è
- ‚úÖ –ú–æ–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ–ø—Ä–æ—Å–∞ –¥–æ 2-5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚ö†Ô∏è –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –ø—Ä–∏ pause/resume (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–ø—Ä–æ—Å–µ)

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (–∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
```javascript
const interval = isPlaying ? 1000 : 10000;  // 1 —Å–µ–∫ / 10 —Å–µ–∫
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü–æ—Å–µ–∫—É–Ω–¥–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (100% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é)
- ‚úÖ –¢–æ—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ù–∞–≥—Ä—É–∑–∫–∞ –≤ 2 —Ä–∞–∑–∞ –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π
- ‚ö†Ô∏è 18,000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å (5 –ø–ª–µ–µ—Ä–æ–≤)

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ë–∞–ª–∞–Ω—Å (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥)
```javascript
const interval = isPlaying ? 2000 : 10000;  // 2 —Å–µ–∫ / 10 —Å–µ–∫
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞
- ‚úÖ –£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (9,000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å)

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–∫–∞—á–∫–∞–º–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –£–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
```javascript
// Backend: –æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
const interval = isPlaying ? 3000 : 10000;

// Frontend: –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 100ms
setInterval(() => {
  if (isPlaying) {
    interpolatedPosition = lastServerPosition + timeSinceLastUpdate;
    updateUI(interpolatedPosition);
  }
}, 100);
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü–ª–∞–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 100ms –≤–∏–∑—É–∞–ª—å–Ω–æ)
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 33% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —Ç–µ–∫—É—â–∏–º –ø–æ–¥—Ö–æ–¥–æ–º
- ‚úÖ 6,000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å (5 –ø–ª–µ–µ—Ä–æ–≤) –≤–º–µ—Å—Ç–æ 9,000
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å (¬±0.5 —Å–µ–∫), –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–ø—Ä–æ—Å–µ
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ frontend-–∫–æ–¥–∞

---

## üìù –í–´–í–û–î–´

### –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ ‚úÖ –û–ü–¢–ò–ú–ê–õ–ï–ù

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- ‚úÖ `getPlayerStatus` (–±–∞–∑–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞, ~500 –±–∞–π—Ç)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: 2 —Å–µ–∫ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏, 10 —Å–µ–∫ –≤ –ø—Ä–æ—Å—Ç–æ–µ
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (Promise.all)

**–ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–∏–π –≤—ã–±–æ—Ä:**
1. WiiM API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±–ª–µ–≥—á—ë–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
2. WebSocket/SSE –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
3. Batch-–∑–∞–ø—Ä–æ—Å—ã –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã (–∫–∞–∂–¥—ã–π –ø–ª–µ–µ—Ä –Ω–∞ —Å–≤–æ—ë–º IP)
4. –ò–Ω—Ç–µ—Ä–≤–∞–ª 2 —Å–µ–∫ - —Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É UX –∏ –Ω–∞–≥—Ä—É–∑–∫–æ–π

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

**–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. ‚úÖ **Client-side –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è** - –ø–ª–∞–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
2. ‚úÖ **Server-side –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (TTL 500ms) - –∑–∞—â–∏—Ç–∞ –æ—Ç burst-–∑–∞–ø—Ä–æ—Å–æ–≤

**–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤ UI (–¥–ª—è power users)
4. Adaptive polling –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
5. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ 1 —Å–µ–∫ polling (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ 100% —Ç–æ—á–Ω–æ—Å—Ç—å –∫–∞–∫ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)

---

## üîß –ì–û–¢–û–í–´–ï –†–ï–®–ï–ù–ò–Ø

### –†–µ—à–µ–Ω–∏–µ #1: Client-side –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è

**–§–∞–π–ª:** `public/js/services/player-service.js`

–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–∏:

```javascript
// –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∑–∏—Ü–∏–π
const positionInterpolation = new Map();

/**
 * –ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –ø–ª–µ–µ—Ä–∞
 */
export function startPositionInterpolation(playerId, initialPosition) {
  positionInterpolation.set(playerId, {
    serverPosition: initialPosition,
    lastUpdate: Date.now(),
    isPlaying: true
  });
}

/**
 * –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é
 */
export function stopPositionInterpolation(playerId) {
  const data = positionInterpolation.get(playerId);
  if (data) {
    data.isPlaying = false;
  }
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
 */
export function getInterpolatedPosition(playerId) {
  const data = positionInterpolation.get(playerId);
  if (!data || !data.isPlaying) {
    return data?.serverPosition || 0;
  }

  const elapsed = (Date.now() - data.lastUpdate) / 1000;
  return data.serverPosition + elapsed;
}

/**
 * –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞
 */
export function updateServerPosition(playerId, serverPosition, isPlaying) {
  positionInterpolation.set(playerId, {
    serverPosition: serverPosition,
    lastUpdate: Date.now(),
    isPlaying: isPlaying
  });
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```javascript
// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
async function refreshPlayer(playerId) {
  const status = await PlayersAPI.getPlayerStatus(playerId);

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
  updateServerPosition(playerId, status.curpos, status.status === 'play');

  // –†–µ–Ω–¥–µ—Ä–∏–º UI
  renderPlayerUI(playerId);
}

// –í UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 100ms
setInterval(() => {
  players.forEach(player => {
    const position = getInterpolatedPosition(player.id);
    updateProgressBar(player.id, position);
  });
}, 100);
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü–ª–∞–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É –≤–∏–∑—É–∞–ª—å–Ω–æ)
- –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ –¥–æ 3-5 —Å–µ–∫—É–Ω–¥
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 40-60%

---

### –†–µ—à–µ–Ω–∏–µ #2: Server-side –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `src/controllers/players.controller.js`

```javascript
// –ö—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤ —Å TTL
const statusCache = new Map();
const CACHE_TTL = 500; // 500ms

export async function getPlayerStatus(req, res, wiimClient) {
  try {
    const { ip } = req.params;
    const now = Date.now();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const cached = statusCache.get(ip);
    if (cached && (now - cached.time) < CACHE_TTL) {
      return res.json(cached.data);
    }

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    const status = await wiimClient.getPlayerStatus(ip);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    statusCache.set(ip, {
      data: status,
      time: now
    });

    res.json(status);
  } catch (error) {
    logWithMs(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–µ–µ—Ä–∞ ${req.params.ip}: ${error.message}`);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞' });
  }
}

// –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
setInterval(() => {
  const now = Date.now();
  for (const [ip, cached] of statusCache.entries()) {
    if (now - cached.time > 10000) {
      statusCache.delete(ip);
    }
  }
}, 10000);
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç burst-–∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —á–∞—Å—Ç–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UI
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å (TTL –≤—Å–µ–≥–æ 500ms)

---

## üìö –ò–°–¢–û–ß–ù–ò–ö–ò

- [WiiM HTTP API Documentation (PDF)](https://www.wiimhome.com/pdf/HTTP%20API%20for%20WiiM%20Products.pdf)
- [WiiM HTTP API GitHub Explorer](https://github.com/cvdlinden/wiim-httpapi)
- [WiiM Java API Implementation](https://github.com/LinzN/wiim-java-api)
- [WiiM Forum - HTTP API Discussion](https://forum.wiimhome.com/threads/wiim-http-api-misc-items.1592/)
- [WiiM MQTT Implementation](https://github.com/denwilliams/wiim-mqtt)

---

*–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–µ–¥—ë–Ω: 2025-12-21*
