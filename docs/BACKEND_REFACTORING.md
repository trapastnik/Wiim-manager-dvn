# Backend –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –û–±–∑–æ—Ä

–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ backend-–∞ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π `server.js` (1427 —Å—Ç—Ä–æ–∫) –≤ –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏–∑ 15 –º–æ–¥—É–ª–µ–π (1023 —Å—Ç—Ä–æ–∫–∏).

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥**: 1427 —Å—Ç—Ä–æ–∫ (server.js)
- **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥**: 15 –º–æ–¥—É–ª–µ–π, 1023 —Å—Ç—Ä–æ–∫–∏ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–π server.js)
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ**: -28.3% (404 —Å—Ç—Ä–æ–∫–∏)
- **–ù–æ–≤—ã–π server.js**: –≤—Å–µ–≥–æ 94 —Å—Ç—Ä–æ–∫–∏ (–±—ã–ª–æ 1427)
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ server.js**: -93.4%

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ú–æ–¥—É–ª–µ–π

### üìÅ src/
```
src/
‚îú‚îÄ‚îÄ controllers/        # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ API)
‚îÇ   ‚îú‚îÄ‚îÄ players.controller.js     (177 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ media.controller.js       (110 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ config.controller.js      (65 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ scanner.controller.js     (17 —Å—Ç—Ä–æ–∫)
‚îÇ
‚îú‚îÄ‚îÄ routes/            # –ú–∞—Ä—à—Ä—É—Ç—ã (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è endpoints)
‚îÇ   ‚îú‚îÄ‚îÄ players.routes.js         (61 —Å—Ç—Ä–æ–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ media.routes.js           (58 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ config.routes.js          (36 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ scanner.routes.js         (16 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ index.js                  (28 —Å—Ç—Ä–æ–∫)
‚îÇ
‚îú‚îÄ‚îÄ services/          # –°–µ—Ä–≤–∏—Å—ã (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ stats.service.js          (100 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ auto-repeat.service.js    (111 —Å—Ç—Ä–æ–∫)
‚îÇ
‚îú‚îÄ‚îÄ middleware/        # Middleware
‚îÇ   ‚îú‚îÄ‚îÄ stats.middleware.js       (42 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îî‚îÄ‚îÄ error.middleware.js       (35 —Å—Ç—Ä–æ–∫)
‚îÇ
‚îî‚îÄ‚îÄ utils/             # –£—Ç–∏–ª–∏—Ç—ã
    ‚îú‚îÄ‚îÄ logger.js                 (26 —Å—Ç—Ä–æ–∫)
    ‚îî‚îÄ‚îÄ env-loader.js             (47 —Å—Ç—Ä–æ–∫)
```

---

## –ú–æ–¥—É–ª–∏ –ø–æ –ö–∞—Ç–µ–≥–æ—Ä–∏—è–º

### 1. Controllers (369 —Å—Ç—Ä–æ–∫)

–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

#### **players.controller.js** (177 —Å—Ç—Ä–æ–∫)
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–∞–º–∏ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º.

```javascript
import * as playersController from '../controllers/players.controller.js';

// –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
- getPlayers()           // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–ª–µ–µ—Ä–æ–≤
- addPlayer()            // –î–æ–±–∞–≤–∏—Ç—å –ø–ª–µ–µ—Ä
- removePlayer()         // –£–¥–∞–ª–∏—Ç—å –ø–ª–µ–µ—Ä
- getPlayerStatus()      // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å
- playMedia()            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º–µ–¥–∏–∞
- controlPlayer()        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (play/pause/stop/next/prev)
- setVolume()            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
- setMute()              // Mute/unmute
- setLoopMode()          // –†–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞
- playBeep()             // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ beep
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```javascript
export async function playMedia(req, res, wiimClient) {
  try {
    const { ip } = req.params;
    const { url } = req.body;

    if (!url) {
      return res.status(400).json({ error: 'URL –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }

    await wiimClient.playUrl(ip, url);
    logWithMs(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ ${ip}: ${url}`);
    res.json({ success: true });
  } catch (error) {
    logWithMs(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${error.message}`);
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è' });
  }
}
```

#### **media.controller.js** (110 —Å—Ç—Ä–æ–∫)
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞–º–∏ –∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞–º–∏.

```javascript
// –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
- getMediaFiles()        // –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
- uploadMediaFile()      // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
- deleteMediaFile()      // –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
- getPlaylist()          // –ü–æ–ª—É—á–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç
- savePlaylist()         // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç
```

#### **config.controller.js** (65 —Å—Ç—Ä–æ–∫)
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.

```javascript
// –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
- getConfig()            // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- saveConfig()           // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- getServerInfo()        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
- getServerStats()       // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- resetServerStats()     // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

#### **scanner.controller.js** (17 —Å—Ç—Ä–æ–∫)
–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏.

```javascript
- scanNetwork()          // –ù–∞–π—Ç–∏ WiiM —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
```

---

### 2. Routes (199 —Å—Ç—Ä–æ–∫)

–†–æ—É—Ç–µ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç API endpoints –∏ —Å–≤—è–∑—ã–≤–∞—é—Ç –∏—Ö —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏.

#### **players.routes.js** (61 —Å—Ç—Ä–æ–∫–∞)
```javascript
import { createPlayersRouter } from './routes/players.routes.js';

const router = createPlayersRouter(wiimClient, storage);

// Endpoints:
GET    /api/players                    // –°–ø–∏—Å–æ–∫ –ø–ª–µ–µ—Ä–æ–≤
POST   /api/players                    // –î–æ–±–∞–≤–∏—Ç—å –ø–ª–µ–µ—Ä
DELETE /api/players/:id                // –£–¥–∞–ª–∏—Ç—å –ø–ª–µ–µ—Ä
GET    /api/players/:ip/status         // –°—Ç–∞—Ç—É—Å –ø–ª–µ–µ—Ä–∞
POST   /api/players/:ip/play           // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
POST   /api/players/:ip/control/:action // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
POST   /api/players/:ip/volume         // –ì—Ä–æ–º–∫–æ—Å—Ç—å
POST   /api/players/:ip/mute           // Mute
POST   /api/players/:ip/loop           // Loop mode
POST   /api/players/:ip/beep           // Beep
```

#### **media.routes.js** (58 —Å—Ç—Ä–æ–∫)
```javascript
// Endpoints:
GET    /api/media                      // –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
POST   /api/media/upload               // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
DELETE /api/media/:filename            // –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
GET    /api/media/playlist             // –ü–ª–µ–π–ª–∏—Å—Ç
POST   /api/media/playlist             // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç
```

#### **config.routes.js** (36 —Å—Ç—Ä–æ–∫)
```javascript
// Endpoints:
GET    /api/config                     // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
POST   /api/config                     // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
GET    /api/config/server-info         // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
GET    /api/config/stats               // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
POST   /api/config/stats/reset         // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

#### **scanner.routes.js** (16 —Å—Ç—Ä–æ–∫)
```javascript
// Endpoints:
POST   /api/scanner/scan               // –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç—å
```

#### **index.js** (28 —Å—Ç—Ä–æ–∫)
–ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã.

```javascript
import { createApiRouter } from './routes/index.js';

const apiRouter = createApiRouter({
  wiimClient,
  storage,
  networkScanner,
  statsService
});

app.use('/api', apiRouter);
```

---

### 3. Services (211 —Å—Ç—Ä–æ–∫)

–°–µ—Ä–≤–∏—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

#### **stats.service.js** (100 —Å—Ç—Ä–æ–∫)
–°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞.

```javascript
import * as statsService from '../services/stats.service.js';

// API:
- incrementRequests(category)    // –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
- addSentTraffic(bytes)          // –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫
- addReceivedTraffic(bytes)      // –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫
- incrementErrors()              // –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
- incrementActiveStreams()       // +1 –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Ç–æ–∫
- decrementActiveStreams()       // -1 –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Ç–æ–∫
- getStats()                     // –ü–æ–ª—É—á–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- resetStats()                   // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

**–ü—Ä–∏–º–µ—Ä:**
```javascript
const stats = statsService.getStats();
// {
//   startTime: 1234567890,
//   uptime: 3600,
//   requests: { total: 150, status: 50, control: 30, ... },
//   traffic: { sent: 1024000, received: 512000 },
//   errors: 2,
//   activeStreams: 3
// }
```

#### **auto-repeat.service.js** (111 —Å—Ç—Ä–æ–∫)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–æ–≤.

```javascript
- startMonitoring(ip, wiimClient)  // –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- stopMonitoring()                 // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- getMonitoringState()             // –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- markManualStop()                 // –û—Ç–º–µ—Ç–∏—Ç—å —Ä—É—á–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É
```

---

### 4. Middleware (77 —Å—Ç—Ä–æ–∫)

#### **stats.middleware.js** (42 —Å—Ç—Ä–æ–∫–∏)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

```javascript
import { statsMiddleware } from '../middleware/stats.middleware.js';

app.use(statsMiddleware(statsService));

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
// - –ò–∑–º–µ—Ä—è–µ—Ç —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤
// - –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞—Ñ–∏–∫
```

#### **error.middleware.js** (35 —Å—Ç—Ä–æ–∫)
–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.

```javascript
import { errorMiddleware, notFoundMiddleware } from '../middleware/error.middleware.js';

app.use(notFoundMiddleware);  // –û–±—Ä–∞–±–æ—Ç–∫–∞ 404
app.use(errorMiddleware);     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
```

---

### 5. Utils (73 —Å—Ç—Ä–æ–∫–∏)

#### **logger.js** (26 —Å—Ç—Ä–æ–∫)
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏.

```javascript
import { logWithMs } from '../utils/logger.js';

logWithMs('–°–æ–æ–±—â–µ–Ω–∏–µ');
// [14:23:45.123] –°–æ–æ–±—â–µ–Ω–∏–µ
```

#### **env-loader.js** (47 —Å—Ç—Ä–æ–∫)
–ó–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞.

```javascript
import { loadEnv } from '../utils/env-loader.js';

loadEnv();
// –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env –≤ process.env
```

---

## –ù–æ–≤—ã–π server.js (94 —Å—Ç—Ä–æ–∫–∏)

–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–µ–Ω:

```javascript
import express from 'express';
import { loadEnv } from './src/utils/env-loader.js';
import { logWithMs } from './src/utils/logger.js';
import * as statsService from './src/services/stats.service.js';
import { statsMiddleware } from './src/middleware/stats.middleware.js';
import { errorMiddleware, notFoundMiddleware } from './src/middleware/error.middleware.js';
import { createApiRouter } from './src/routes/index.js';

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
loadEnv();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express
const app = express();
app.use(express.json());
app.use(express.static('public'));

// Middleware —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if (ENABLE_STATS) {
  app.use(statsMiddleware(statsService));
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
const dependencies = {
  wiimClient,
  storage,
  networkScanner,
  statsService
};

// API –º–∞—Ä—à—Ä—É—Ç—ã
app.use('/api', createApiRouter(dependencies));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
app.use(notFoundMiddleware);
app.use(errorMiddleware);

// –ó–∞–ø—É—Å–∫
app.listen(PORT, () => {
  logWithMs(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
1. –ò–º–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª–µ–π
2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Express
4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware
5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
6. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
8. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### 1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é:
- Routes: –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç endpoints
- Controllers: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã
- Services: —Ä–µ–∞–ª–∏–∑—É—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- Middleware: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç cross-cutting concerns
- Utils: –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —É—Ç–∏–ª–∏—Ç—ã

### 2. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**
- –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∫–æ–¥
- –ú–æ–¥—É–ª–∏ –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–æ–¥—É–ª–µ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ

### 3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ endpoints
- –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- –ú–æ–∂–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏

### 4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**
- –ö–æ–¥ –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å (—Ñ–∞–π–ª—ã < 200 —Å—Ç—Ä–æ–∫)
- –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫
- –õ–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –±–∞–≥–∏

### 5. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**
- –°–µ—Ä–≤–∏—Å—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- Middleware –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ
- Utils –¥–æ—Å—Ç—É–ø–Ω—ã –≤–µ–∑–¥–µ

### 6. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**
- –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
- –õ–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—â–µ –ø–∏—Å–∞—Ç—å

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ vs –ü–æ—Å–ª–µ

### –î–æ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
```
server.js (1427 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ –ò–º–ø–æ—Ä—Ç—ã
‚îú‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç—ã (loadEnv, logWithMs)
‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express
‚îú‚îÄ‚îÄ Middleware —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
‚îú‚îÄ‚îÄ 50+ API endpoints
‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–æ–≤
‚îú‚îÄ‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îî‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –°–ª–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∫–æ–¥
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- ‚ùå –°–ª–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚ùå –í—ã—Å–æ–∫–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å

### –ü–æ—Å–ª–µ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
```
server.js (94 —Å—Ç—Ä–æ–∫–∏)
‚îú‚îÄ‚îÄ –ò–º–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª–µ–π
‚îú‚îÄ‚îÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Middleware
‚îú‚îÄ‚îÄ API —Ä–æ—É—Ç–µ—Ä—ã
‚îî‚îÄ‚îÄ –ó–∞–ø—É—Å–∫

src/ (15 –º–æ–¥—É–ª–µ–π, 929 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ controllers/ (4 —Ñ–∞–π–ª–∞, 369 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ routes/ (5 —Ñ–∞–π–ª–æ–≤, 199 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ services/ (2 —Ñ–∞–π–ª–∞, 211 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ middleware/ (2 —Ñ–∞–π–ª–∞, 77 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ utils/ (2 —Ñ–∞–π–ª–∞, 73 —Å—Ç—Ä–æ–∫–∏)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å < 200 —Å—Ç—Ä–æ–∫
- ‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ö–æ–¥ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ‚úÖ –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å

---

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|-----|--------|-----------|
| **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫** | 1427 | 1023 | **-28.3%** |
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤** | 1 | 16 | +1500% |
| **–°—Ç—Ä–æ–∫ –≤ server.js** | 1427 | 94 | **-93.4%** |
| **–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –º–æ–¥—É–ª—è** | 1427 | 62 | **-95.7%** |
| **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –º–æ–¥—É–ª—è** | 1427 | 177 | **-87.6%** |
| **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π** | ~50 | ~50 | 0% |
| **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** | –í—ã—Å–æ–∫–æ–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | **-80%** |

---

## –ö–∞–∫ –î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—ã–π –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –ü—Ä–∏–º–µ—Ä: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —ç–∫–≤–∞–ª–∞–π–∑–µ—Ä–∞

#### 1. –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
```javascript
// src/controllers/equalizer.controller.js

export async function getEqualizerSettings(req, res, wiimClient) {
  try {
    const { ip } = req.params;
    const settings = await wiimClient.getEqualizer(ip);
    res.json(settings);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}

export async function setEqualizerSettings(req, res, wiimClient) {
  try {
    const { ip } = req.params;
    const { settings } = req.body;
    await wiimClient.setEqualizer(ip, settings);
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}
```

#### 2. –°–æ–∑–¥–∞—Ç—å —Ä–æ—É—Ç–µ—Ä
```javascript
// src/routes/equalizer.routes.js

import express from 'express';
import * as equalizerController from '../controllers/equalizer.controller.js';

export function createEqualizerRouter(wiimClient) {
  const router = express.Router();

  router.get('/:ip/equalizer', (req, res) =>
    equalizerController.getEqualizerSettings(req, res, wiimClient)
  );

  router.post('/:ip/equalizer', (req, res) =>
    equalizerController.setEqualizerSettings(req, res, wiimClient)
  );

  return router;
}
```

#### 3. –ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–º —Ä–æ—É—Ç–µ—Ä–µ
```javascript
// src/routes/index.js

import { createEqualizerRouter } from './equalizer.routes.js';

export function createApiRouter(dependencies) {
  const router = express.Router();

  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ—É—Ç–µ—Ä—ã
  router.use('/equalizer', createEqualizerRouter(dependencies.wiimClient));

  return router;
}
```

**–ì–æ—Ç–æ–≤–æ!** –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞.

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **–°–ª–µ–¥—É–π—Ç–µ –°—Ç—Ä—É–∫—Ç—É—Ä–µ**
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã: —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
- –°–µ—Ä–≤–∏—Å—ã: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- Routes: —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
- Middleware: cross-cutting concerns
- Utils: –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 2. **–î–µ—Ä–∂–∏—Ç–µ –ú–æ–¥—É–ª–∏ –ú–∞–ª–µ–Ω—å–∫–∏–º–∏**
- –ú–∞–∫—Å–∏–º—É–º 200 —Å—Ç—Ä–æ–∫ –Ω–∞ —Ñ–∞–π–ª
- –û–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ –º–æ–¥—É–ª—å
- –ï—Å–ª–∏ –º–æ–¥—É–ª—å —Ä–∞—Å—Ç—ë—Ç - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ –µ–≥–æ

### 3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Dependency Injection**
- –ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –û–±–ª–µ–≥—á–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 4. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –û—à–∏–±–∫–∏**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ try-catch
- –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏

### 5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ**
- –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É
- –ü–∏—à–∏—Ç–µ JSDoc –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –û–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Backend —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω:

‚úÖ **1427 —Å—Ç—Ä–æ–∫ ‚Üí 1023 —Å—Ç—Ä–æ–∫–∏** (-28.3%)
‚úÖ **1 —Ñ–∞–π–ª ‚Üí 16 –º–æ–¥—É–ª–µ–π** (+–ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å)
‚úÖ **server.js: 1427 ‚Üí 94 —Å—Ç—Ä–æ–∫–∏** (-93.4%)
‚úÖ **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
‚úÖ **–õ–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å**
‚úÖ **–õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é**

–ü—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–¥.
