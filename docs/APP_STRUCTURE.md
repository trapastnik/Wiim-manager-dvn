# Структура app.js

Документация по структуре файла `/public/app.js` (2270 строк).

## Общая структура

Файл организован в логические секции, разделенные комментариями `// ===`:

```
app.js (2270 строк)
├── Глобальные переменные (строки 1-26)
├── Инициализация DOMContentLoaded (строки 27-54)
├── СИСТЕМА СООБЩЕНИЙ (строки 57-83)
├── УПРАВЛЕНИЕ ВКЛАДКАМИ (строки 84-115)
├── УПРАВЛЕНИЕ ПЛЕЕРАМИ (строки 116-334)
├── УПРАВЛЕНИЕ ПЛЕЕРОМ - legacy (строки 335-459)
├── УПРАВЛЕНИЕ МЕДИА (строки 460-570)
├── УТИЛИТЫ (строки 571-577)
├── МУЛЬТИПЛЕЕР УПРАВЛЕНИЕ (строки 578-615)
├── УПРАВЛЕНИЕ ГРУППАМИ ПЛЕЕРОВ (строки 616-815)
├── ДЕМО-РЕЖИМ (строки 816-1784)
├── СТАТИСТИКА СЕРВЕРА (строки 1785-1941)
├── НЕЗАВИСИМЫЙ СТАТУС ПЛЕЕРОВ (строки 1942-2085) [УДАЛЕНО из UI]
├── ИЗМЕНЕНИЕ РАЗМЕРА ПАНЕЛИ (строки 2086-2136)
└── НАСТРОЙКИ СИСТЕМЫ (строки 2137-2270)
```

## Детальная структура секций

### 1. Глобальные переменные (1-26)

**Состояние приложения:**
- `currentVolume`, `isMuted`, `isPlaying` - состояние воспроизведения
- `currentTab`, `activePlayerId` - активная вкладка и плеер
- `messageCounter`, `MAX_MESSAGES` - лимит сообщений

**Данные:**
- `allPlayers[]` - список всех плееров
- `allMediaFiles[]` - список медиа файлов
- `playerSelections{}` - выбранные файлы для каждого плеера
- `playerStatuses{}` - статусы плееров
- `playerDiagnostics{}` - диагностическая информация
- `playerLoopModes{}` - режимы повтора
- `serverInfo` - информация о сервере

**Таймеры:**
- `autoRefreshTimer` - временное автообновление
- `adaptiveRefreshTimer` - адаптивное обновление
- `autoRefreshCount` - счётчик обновлений

**Группы:**
- `playerGroups[]` - сохранённые группы
- `selectedPlayersForGroup` - Set для выбора плееров

**Демо-режим:**
- `isDemoMode` - флаг демо-режима
- `demoPlayers[]`, `demoMediaFiles[]` - виртуальные данные

### 2. Инициализация (27-54)

```javascript
document.addEventListener('DOMContentLoaded', async () => {
    // Получение информации о сервере
    // Загрузка сохранённых данных
    // Инициальная загрузка плееров и медиа
    // Первое обновление статусов
});
```

### 3. Система сообщений (57-83)

**Функции:**
- `addMessage(text, type)` - добавление сообщения в панель
- Типы: `'info'`, `'success'`, `'error'`, `'warning'`
- Автоматическая обрезка до MAX_MESSAGES
- Timestamp в формате HH:MM:SS.mmm

### 4. Управление вкладками (84-115)

**Функции:**
- `switchTab(tabName)` - переключение между вкладками
- Вкладки: `player`, `players`, `media`, `diagnostics`, `settings`
- Управление CSS классами `.active`

### 5. Управление плеерами (116-334)

**Основные функции:**
- `loadPlayers()` - загрузка списка плееров с сервера
- `renderPlayers(players)` - рендеринг списка в UI
- `scanPlayers()` - сканирование сети (с модальным окном)
- `addPlayerManual()` - добавление плеера вручную
- `removePlayer(playerId)` - удаление плеера
- `closeScanModal()` - закрытие модального окна сканирования

**Особенности:**
- Анимированный прогресс-бар сканирования
- Автоматическое определение подсети
- Timeout 2 минуты на сканирование

### 6. Управление медиа (460-570)

**Функции:**
- `loadMedia()` - загрузка списка медиа файлов
- `renderMedia(files)` - рендеринг списка
- `uploadFile(file)` - загрузка файла на сервер
- `deleteMedia(fileName)` - удаление файла
- Использует FormData для upload

### 7. Мультиплеер управление (578-615)

**localStorage функции:**
- `loadPlayerSelections()` - загрузка выборов
- `savePlayerSelections()` - сохранение выборов (skip в демо-режиме)
- `loadLoopModes()` - загрузка режимов повтора
- `saveLoopModes()` - сохранение режимов повтора

### 8. Управление группами (616-815)

**Основные функции:**
- `togglePlayerSelection(playerId)` - выбор плеера для группы
- `createPlayerGroup()` - создание группы с prompt для имени
- `deletePlayerGroup(groupId)` - удаление группы с confirm
- `playGroup(groupId)` - **синхронный запуск группы через Promise.all**
- `stopGroup(groupId)` - остановка группы
- `setGroupVolume(groupId, volume)` - управление громкостью группы
- `renderPlayerGroups()` - рендеринг карточек групп
- `updateGroupSelectionUI()` - обновление чекбоксов

**localStorage:**
- `savePlayerGroups()` / `loadPlayerGroups()`

**Особенности:**
- Синхронный старт через `Promise.all()`
- Автоматический temporary refresh после запуска группы

### 9. Демо-режим (816-1784)

**Основные функции:**
- `createDemoData()` - создание виртуальных данных
  - 7 плееров (Гостиная Л/П, Спальня, Кухня, Кабинет, Ванная, Коридор)
  - 5 медиа файлов (диалоги, ambient, jazz, classical)
- `enableDemoMode()` - включение демо-режима
- `disableDemoMode()` - выключение с перезагрузкой страницы
- `animateDemoProgress()` - анимация прогресса (только прогресс-бары)
- `updatePlayerProgress(playerId, status)` - обновление без перерисовки
- `startDemoAnimation()` - запуск таймера анимации

**Особенности:**
- Не сохраняет в localStorage
- Обновляет только прогресс-бары, не трогает dropdown
- Добавляет метку "ДЕМО" в заголовок

### 10. Управление плеерами - детали (внутри секции 816-1784)

**Функции воспроизведения:**
- `playPlayer(playerId, skipRefresh, startTime)` - воспроизведение
- `pausePlayer(playerId)` - пауза
- `stopPlayer(playerId)` - остановка (устанавливает `playerManualStops`)
- `playAll()`, `stopAll()` - массовые операции
- `beepPlayer(playerId)` - звуковой сигнал для идентификации

**Управление громкостью:**
- `setPlayerVolume(playerId, volume)` - установка громкости
- `adjustVolume(playerId, delta)` - изменение на ±delta

**Режим повтора:**
- `toggleLoopMode(playerId)` - переключение 0 ↔ 2
- `toggleLoopModeAll()` - для всех плееров
- `updateLoopAllButton()` - обновление UI кнопки

**Выбор медиа:**
- `selectMediaForPlayer(playerId, filePath)` - выбор файла
- `updatePlayerPlayButton(playerId, filePath)` - обновление кнопки (без перерисовки)

**Автообновление:**
- `refreshAllPlayers()` - обновление всех статусов
- `startTemporaryAutoRefresh(count, interval)` - временное авто-обновление
- `checkAndRestartIfNeeded(playerId, statusData)` - предиктивный перезапуск

**Рендеринг:**
- `renderMultiPlayers()` - **главная функция рендеринга** (строки 1163-1365)
  - Карточки плееров с чекбоксами
  - Dropdown выбора файлов
  - Прогресс-бары
  - Wi-Fi информация
  - Управление громкостью и loop

**Вспомогательные:**
- `getPlayerName(playerId)` - получение имени плеера

### 11. Статистика сервера (1785-1941)

**Функции:**
- `refreshDiagnostics()` - загрузка диагностики с `/api/diagnostics`
- `renderDiagnostics(data)` - рендеринг карточек со статистикой
- `updateSystemInfo()` - обновление счётчиков в настройках

### 12. Независимый статус плееров (1942-2085)

**⚠️ УДАЛЕНО ИЗ UI** - вкладка больше не отображается

**Функции:**
- `refreshIndependentStatus()` - независимый опрос плееров
- `renderIndependentStatus(players)` - рендеринг карточек

### 13. Изменение размера панели (2086-2136)

**Функции:**
- Drag-to-resize для правой панели сообщений
- Сохранение ширины в localStorage
- Min: 250px, Max: 800px

### 14. Настройки системы (2137-2270)

**Функции:**
- `loadSettings()` - загрузка из localStorage
- `saveSettings()` - сохранение настроек loop
- `resetSettings()` - сброс к defaults
- `updateSettingsDisplay()` - обновление UI

**Настройки:**
- `loopRestartThreshold` - порог перезапуска (default: 2000ms)
- `loopResetThreshold` - порог сброса (default: 5000ms)

## Ключевые архитектурные решения

### 1. Адаптивное обновление

Вместо постоянного polling каждые 3 секунды:
- Используется `startTemporaryAutoRefresh(count, interval)`
- Активируется только при воспроизведении
- Автоматически останавливается когда все плееры остановлены

### 2. Предиктивный рестарт в loop-режиме

- За 2 секунды (configurable) до конца трека отправляется команда play
- Используется для плавного зацикливания без пауз
- Флаг `playerManualStops` предотвращает автоперезапуск после ручной остановки

### 3. Синхронный запуск групп

```javascript
const promises = playersWithFiles.map(playerId =>
    playPlayer(playerId, true, performance.now())
);
await Promise.all(promises);
```

- Минимизирует разброс времени старта
- Использует `performance.now()` для измерения задержек

### 4. Оптимизация рендеринга

- **Проблема**: Полная перерисовка сбрасывает dropdown и фокус
- **Решение**:
  - `updatePlayerPlayButton()` - точечное обновление кнопки
  - `updatePlayerProgress()` - обновление только прогресс-бара
  - Демо-режим не вызывает `renderMultiPlayers()` в цикле

### 5. Демо-режим без побочных эффектов

- `savePlayerSelections()` пропускает сохранение если `isDemoMode`
- Виртуальные данные не перезаписывают реальные
- При выходе - полная перезагрузка страницы

## Зависимости между модулями

```
┌─────────────────┐
│  Глобальное     │
│  состояние      │◄──────┐
└────────┬────────┘       │
         │                │
    ┌────▼────────────────┴───┐
    │  Все функции имеют      │
    │  доступ к глобальным    │
    │  переменным             │
    └────┬────────────────────┘
         │
    ┌────▼─────────────────────┐
    │  HTML onclick handlers   │
    │  вызывают глобальные     │
    │  функции напрямую        │
    └──────────────────────────┘
```

**Проблемы текущей архитектуры:**
- Все функции в глобальной области видимости
- Тесная связь с DOM через `onclick`
- Сложно тестировать изолированно
- Нет четкого разделения ответственности

## План будущего рефакторинга

Когда будет время и необходимость:

### Фаза 1: Подготовка
1. Создать комплексные тесты текущего функционала
2. Задокументировать все edge cases
3. Создать резервную копию

### Фаза 2: Модульная структура

```
public/js/
├── core/
│   ├── state.js          # Centralized state management
│   ├── api.js            # API calls
│   └── storage.js        # localStorage wrapper
├── ui/
│   ├── messages.js       # Message system
│   ├── tabs.js           # Tab management
│   └── resize.js         # Panel resize
├── features/
│   ├── players.js        # Player management
│   ├── media.js          # Media library
│   ├── groups.js         # Group management
│   ├── demo.js           # Demo mode
│   └── settings.js       # Settings
└── app.js                # Main entry point
```

### Фаза 3: Event-driven architecture

Заменить прямые вызовы на события:

```javascript
// Вместо: renderMultiPlayers()
// Использовать:
EventBus.emit('players:updated', allPlayers);
```

### Фаза 4: Постепенная миграция

1. Один модуль за раз
2. Dual-mode поддержка (старый + новый код)
3. A/B тестирование
4. Полный переход после стабилизации

## Метрики кода

- **Всего строк**: 2270
- **Функций**: ~80
- **Глобальных переменных**: 25
- **Секций**: 14
- **API endpoints**: ~15

## Рекомендации

### Краткосрочные (можно делать сейчас):
1. ✅ Удалена вкладка "Статус плееров"
2. Добавить JSDoc комментарии к функциям
3. Вынести константы в отдельную секцию
4. Разбить длинные функции (>100 строк)

### Долгосрочные (когда будет время):
1. Полный рефакторинг в модули ES6
2. Добавить TypeScript для type safety
3. Внедрить React/Vue для reactive UI
4. Unit тесты для критических функций

## Выводы

Текущий код:
- ✅ Работает стабильно
- ✅ Логически организован
- ✅ Хорошо документирован комментариями
- ⚠️ Монолитный (2270 строк)
- ⚠️ Глобальное состояние
- ⚠️ Сложно тестировать

**Вердикт**: Не трогать пока работает. Рефакторинг - на будущее, когда появятся серьёзные проблемы с поддержкой или масштабированием.
