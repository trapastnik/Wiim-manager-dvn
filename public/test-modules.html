<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –º–æ–¥—É–ª–µ–π WiiM</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        #system-messages {
            max-height: 200px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .message-item {
            margin: 2px 0;
        }
        .message-item.success { color: #28a745; }
        .message-item.error { color: #dc3545; }
        .message-item.warning { color: #ffc107; }
        .message-item.info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã WiiM</h1>

    <!-- –¢–µ—Å—Ç 1: AppState -->
    <div class="test-section">
        <h2>1. –¢–µ—Å—Ç AppState (State Management)</h2>
        <button onclick="testAppState()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="test-appstate-result" class="result"></div>
    </div>

    <!-- –¢–µ—Å—Ç 2: –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="test-section">
        <h2>2. –¢–µ—Å—Ç —É—Ç–∏–ª–∏—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <button onclick="testFormatUtils()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="test-format-result" class="result"></div>
    </div>

    <!-- –¢–µ—Å—Ç 3: DOM —É—Ç–∏–ª–∏—Ç—ã -->
    <div class="test-section">
        <h2>3. –¢–µ—Å—Ç DOM —É—Ç–∏–ª–∏—Ç</h2>
        <button onclick="testDOMUtils()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="test-dom-result" class="result"></div>
        <div id="test-element" style="display:none;">–¢–µ—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</div>
    </div>

    <!-- –¢–µ—Å—Ç 4: –°–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="test-section">
        <h2>4. –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
        <button onclick="testMessages()">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</button>
        <button onclick="clearMessages()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <div id="system-messages"></div>
    </div>

    <!-- –¢–µ—Å—Ç 5: API –º–æ–¥—É–ª–∏ -->
    <div class="test-section">
        <h2>5. –¢–µ—Å—Ç API –º–æ–¥—É–ª–µ–π (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)</h2>
        <button onclick="testAPIModules()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
        <div id="test-api-result" class="result"></div>
    </div>

    <!-- –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="test-section">
        <h2>üìä –°–≤–æ–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤</h2>
        <div id="test-summary" class="result"></div>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–æ–¥—É–ª–∏
        import { appState } from './js/state/AppState.js';
        import { addMessage, clearMessages } from './js/ui/messages.js';
        import { switchTab } from './js/ui/tabs.js';
        import { formatFileSize, formatTime, formatTimestamp, formatUptime } from './js/utils/format.js';
        import * as dom from './js/utils/dom.js';
        import * as PlayersAPI from './js/api/players-api.js';
        import * as MediaAPI from './js/api/media-api.js';
        import * as ConfigAPI from './js/api/config-api.js';

        // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        window.appState = appState;
        window.addMessage = addMessage;
        window.clearMessages = clearMessages;
        window.formatFileSize = formatFileSize;
        window.formatTime = formatTime;
        window.formatTimestamp = formatTimestamp;
        window.formatUptime = formatUptime;
        window.dom = dom;
        window.PlayersAPI = PlayersAPI;
        window.MediaAPI = MediaAPI;
        window.ConfigAPI = ConfigAPI;

        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        function logTest(name, passed, details = '') {
            testResults.total++;
            if (passed) {
                testResults.passed++;
                return `‚úÖ ${name}: PASSED ${details}\n`;
            } else {
                testResults.failed++;
                return `‚ùå ${name}: FAILED ${details}\n`;
            }
        }

        // –¢–µ—Å—Ç 1: AppState
        window.testAppState = function() {
            const result = document.getElementById('test-appstate-result');
            let output = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AppState...\n\n';

            try {
                // –¢–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–µ–µ—Ä–æ–≤
                const testPlayers = [{id: '1', name: 'Test Player 1'}, {id: '2', name: 'Test Player 2'}];
                appState.setPlayers(testPlayers);
                const players = appState.getPlayers();
                output += logTest('setPlayers/getPlayers', JSON.stringify(players) === JSON.stringify(testPlayers));

                // –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–µ–µ—Ä–∞
                appState.setPlayerStatus('1', {status: 'playing', volume: 50});
                const status = appState.getPlayerStatus('1');
                output += logTest('setPlayerStatus/getPlayerStatus', status.status === 'playing');

                // –¢–µ—Å—Ç –≥—Ä—É–ø–ø
                appState.addPlayerToGroupSelection('1');
                appState.addPlayerToGroupSelection('2');
                const selection = appState.getGroupSelection();
                output += logTest('Group selection', selection.size === 2);

                // –¢–µ—Å—Ç –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞
                appState.enableDemoMode();
                output += logTest('enableDemoMode', appState.isDemoModeEnabled() === true);
                appState.disableDemoMode();
                output += logTest('disableDemoMode', appState.isDemoModeEnabled() === false);

                // –¢–µ—Å—Ç reset
                appState.reset();
                output += logTest('reset', appState.getPlayers().length === 0);

                output += '\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã AppState –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!';
                result.className = 'result success';
            } catch (error) {
                output += `\n‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                result.className = 'result error';
            }

            result.textContent = output;
            updateSummary();
        };

        // –¢–µ—Å—Ç 2: –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.testFormatUtils = function() {
            const result = document.getElementById('test-format-result');
            let output = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...\n\n';

            try {
                // –¢–µ—Å—Ç formatFileSize
                output += logTest('formatFileSize(0)', formatFileSize(0) === '0 B');
                output += logTest('formatFileSize(1024)', formatFileSize(1024) === '1 KB');
                output += logTest('formatFileSize(1048576)', formatFileSize(1048576) === '1 MB');
                output += `  ‚Üí ${formatFileSize(1234567)}\n`;

                // –¢–µ—Å—Ç formatTime
                output += logTest('formatTime(0)', formatTime(0) === '00:00');
                output += logTest('formatTime(65000)', formatTime(65000) === '01:05');
                output += logTest('formatTime(125000)', formatTime(125000) === '02:05');
                output += `  ‚Üí ${formatTime(3661000)} (1h 1m 1s)\n`;

                // –¢–µ—Å—Ç formatTimestamp
                const timestamp = formatTimestamp();
                output += logTest('formatTimestamp', /^\d{2}:\d{2}:\d{2}\.\d{3}$/.test(timestamp));
                output += `  ‚Üí ${timestamp}\n`;

                // –¢–µ—Å—Ç formatUptime
                output += `formatUptime(5000) ‚Üí ${formatUptime(5000)}\n`;
                output += `formatUptime(65000) ‚Üí ${formatUptime(65000)}\n`;
                output += `formatUptime(3665000) ‚Üí ${formatUptime(3665000)}\n`;
                output += `formatUptime(90000000) ‚Üí ${formatUptime(90000000)}\n`;

                output += '\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–π–¥–µ–Ω—ã!';
                result.className = 'result success';
            } catch (error) {
                output += `\n‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                result.className = 'result error';
            }

            result.textContent = output;
            updateSummary();
        };

        // –¢–µ—Å—Ç 3: DOM —É—Ç–∏–ª–∏—Ç—ã
        window.testDOMUtils = function() {
            const result = document.getElementById('test-dom-result');
            let output = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DOM —É—Ç–∏–ª–∏—Ç...\n\n';

            try {
                // –¢–µ—Å—Ç getElement
                const elem = dom.getElement('test-element');
                output += logTest('getElement', elem !== null);

                // –¢–µ—Å—Ç showElement/hideElement
                dom.showElement('test-element');
                output += logTest('showElement', elem.style.display === 'block');
                dom.hideElement('test-element');
                output += logTest('hideElement', elem.style.display === 'none');

                // –¢–µ—Å—Ç setText
                dom.setText('test-element', '–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç');
                output += logTest('setText', elem.textContent === '–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç');

                // –¢–µ—Å—Ç createElement
                const newElem = dom.createElement('div', {
                    className: 'test-class',
                    textContent: 'Test content'
                });
                output += logTest('createElement', newElem.className === 'test-class' && newElem.textContent === 'Test content');

                output += '\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã DOM —É—Ç–∏–ª–∏—Ç –ø—Ä–æ–π–¥–µ–Ω—ã!';
                result.className = 'result success';
            } catch (error) {
                output += `\n‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                result.className = 'result error';
            }

            result.textContent = output;
            updateSummary();
        };

        // –¢–µ—Å—Ç 4: –°–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        window.testMessages = function() {
            addMessage('–¢–µ—Å—Ç–æ–≤–æ–µ INFO —Å–æ–æ–±—â–µ–Ω–∏–µ', 'info');
            addMessage('–¢–µ—Å—Ç–æ–≤–æ–µ SUCCESS —Å–æ–æ–±—â–µ–Ω–∏–µ', 'success');
            addMessage('–¢–µ—Å—Ç–æ–≤–æ–µ WARNING —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
            addMessage('–¢–µ—Å—Ç–æ–≤–æ–µ ERROR —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
            addMessage('–°–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!', 'success');
        };

        // –¢–µ—Å—Ç 5: API –º–æ–¥—É–ª–∏
        window.testAPIModules = function() {
            const result = document.getElementById('test-api-result');
            let output = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã API –º–æ–¥—É–ª–µ–π...\n\n';

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ PlayersAPI
                const playerMethods = ['getPlayers', 'scanPlayers', 'addPlayer', 'removePlayer',
                                      'playMedia', 'pausePlayer', 'stopPlayer', 'setVolume',
                                      'setLoopMode', 'playBeep'];
                output += 'PlayersAPI –º–µ—Ç–æ–¥—ã:\n';
                playerMethods.forEach(method => {
                    const exists = typeof PlayersAPI[method] === 'function';
                    output += logTest(`  ${method}`, exists);
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ MediaAPI
                const mediaMethods = ['getMediaFiles', 'uploadMediaFile', 'deleteMediaFile', 'getPlaylist'];
                output += '\nMediaAPI –º–µ—Ç–æ–¥—ã:\n';
                mediaMethods.forEach(method => {
                    const exists = typeof MediaAPI[method] === 'function';
                    output += logTest(`  ${method}`, exists);
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ ConfigAPI
                const configMethods = ['getConfig', 'saveLoopModes', 'saveSettings',
                                      'getServerInfo', 'getServerStats'];
                output += '\nConfigAPI –º–µ—Ç–æ–¥—ã:\n';
                configMethods.forEach(method => {
                    const exists = typeof ConfigAPI[method] === 'function';
                    output += logTest(`  ${method}`, exists);
                });

                output += '\n‚úÖ –í—Å–µ API –º–æ–¥—É–ª–∏ –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É!';
                result.className = 'result success';
            } catch (error) {
                output += `\n‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                result.className = 'result error';
            }

            result.textContent = output;
            updateSummary();
        };

        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const percent = testResults.total > 0 ?
                Math.round((testResults.passed / testResults.total) * 100) : 0;

            summary.innerHTML = `
<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong>
–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${testResults.total}
–ü—Ä–æ–π–¥–µ–Ω–æ: ${testResults.passed} ‚úÖ
–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${testResults.failed} ‚ùå
–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: ${percent}%

${testResults.failed === 0 ? 'üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!' : '‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã'}
            `;
            summary.className = testResults.failed === 0 ? 'result success' : 'result error';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('‚úÖ –ú–æ–¥—É–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
        console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:', {
            appState,
            addMessage,
            formatFileSize,
            PlayersAPI,
            MediaAPI,
            ConfigAPI
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        addMessage('–°–∏—Å—Ç–µ–º–∞ –º–æ–¥—É–ª–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        addMessage('–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏', 'info');
    </script>
</body>
</html>
