# Loop Mode - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –û–±–∑–æ—Ä

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω **WiiM Native Loop** - —Ä–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞ —Ç—Ä–µ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ WiiM.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### WiiM Native Loop (–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º)

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
1. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ WiiM —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ `setPlayerCmd:loopmode:N`
2. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —ç—Ç–æ—Ç —Ä–µ–∂–∏–º –∏ **—Å–∞–º–æ** –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —Ç—Ä–µ–∫ –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è
3. –†–∞–±–æ—Ç–∞–µ—Ç **–∞–≤—Ç–æ–Ω–æ–º–Ω–æ** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É

**–†–µ–∂–∏–º—ã:**
- `0` - –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (loop OFF)
- `1` - –ü–æ–≤—Ç–æ—Ä –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞ (single repeat)
- `2` - –ü–æ–≤—Ç–æ—Ä –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ (repeat all) **‚Üê –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**
- `-1` - –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (shuffle)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–∞–¥—ë–∂–Ω–æ - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–∞–º–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–æ–º
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä—ã—Ç
- ‚úÖ –ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å
- ‚úÖ –ù–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–∞–º–∏

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ UI

### –í —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ:

1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –≤ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º** (–∫–Ω–æ–ø–∫–∞ –≤ —à–∞–ø–∫–µ)
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **"–ü–ª–µ–µ—Ä"**
3. –ù–∞–π–¥–∏—Ç–µ –ø–∞–Ω–µ–ª—å **"üîÅ –†–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–∞ —Ç—Ä–µ–∫–æ–≤"**
4. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"üîÅ Native Loop: OFF/ON"**

**–ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `üîÅ Native Loop: ON` (–∑–µ–ª—ë–Ω–∞—è) - –ø–æ–≤—Ç–æ—Ä **–≤–∫–ª—é—á—ë–Ω** –¥–ª—è –≤—Å–µ—Ö –ø–ª–µ–µ—Ä–æ–≤
- `üîÅ Native Loop: OFF` (—Å–µ—Ä–∞—è) - –ø–æ–≤—Ç–æ—Ä **–≤—ã–∫–ª—é—á–µ–Ω** –¥–ª—è –≤—Å–µ—Ö –ø–ª–µ–µ—Ä–æ–≤

### –í–∞–∂–Ω–æ:

- ‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **–∫–æ –≤—Å–µ–º –ø–ª–µ–µ—Ä–∞–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**
- ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- ‚ö†Ô∏è –ü–∞–Ω–µ–ª—å –≤–∏–¥–Ω–∞ **—Ç–æ–ª—å–∫–æ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ**

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ

```javascript
// –í–∫–ª—é—á–∏—Ç—å Native Loop –¥–ª—è –≤—Å–µ—Ö –ø–ª–µ–µ—Ä–æ–≤
window.toggleNativeLoop();

// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞
window.setLoopMode('192.168.1.100', 2);  // 2 = repeat all
window.setLoopMode('192.168.1.100', 0);  // 0 = loop off
window.setLoopMode('192.168.1.100', 1);  // 1 = single repeat
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:

```javascript
// –í player-service.js:playPlayer()
const loopMode = appState.getPlayerLoopMode(playerId) || 2;
await PlayersAPI.setLoopMode(playerId, loopMode);
await PlayersAPI.playMedia(playerId, fileUrl);
```

**–õ–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ –¥–ª—è –ø–ª–µ–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Ä–µ–∂–∏–º ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π**
2. –ï—Å–ª–∏ —Ä–µ–∂–∏–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **2** (repeat all) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤:
- `playPlayer(playerId)` - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–º –ø–ª–µ–µ—Ä–µ
- `playAll()` - –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø–ª–µ–µ—Ä–æ–≤
- `playMediaOnAllPlayers(fileUrl)` - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ –≤—Å–µ—Ö
- `playGroup(groupId)` - –∑–∞–ø—É—Å–∫ –≥—Ä—É–ø–ø—ã –ø–ª–µ–µ—Ä–æ–≤

## –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
```javascript
// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ConfigSync.saveLoopModes(); // debounced 300ms
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
```javascript
// –í app-main.js –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
if (config.playerLoopModes) {
  Object.entries(config.playerLoopModes).forEach(([playerId, mode]) => {
    appState.setPlayerLoopMode(playerId, mode);
  });
}
```

## –§–∞–π–ª—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:**
- `/public/js/services/loop-mode.service.js` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Loop Mode
- `/public/js/services/player-service.js` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ loop mode –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
- `/public/js/services/config-sync.service.js` - –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- `/public/js/api/players-api.js` - API –≤—ã–∑–æ–≤—ã

**UI:**
- `/public/index.html` - –ø–∞–Ω–µ–ª—å Loop Mode
- `/public/style.css` - —Å—Ç–∏–ª–∏ –ø–∞–Ω–µ–ª–∏

**–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å:**
- `/src/routes/players.routes.js` - —Ä–æ—É—Ç `POST /:ip/loop`
- `/src/controllers/players.controller.js` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `setLoopMode()`
- `/wiim-client.js` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ WiiM —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```javascript
// –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–µ–∂–∏–º—ã
appState.getAllLoopModes()
// { "192.168.1.100": 2, "192.168.1.101": 2 }

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∂–∏–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞
appState.getPlayerLoopMode('192.168.1.100')
// 2

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI
LoopModeService.getNativeLoopState()
// true (–≤—Å–µ –ø–ª–µ–µ—Ä—ã –≤ —Ä–µ–∂–∏–º–µ 2)
```

### –õ–æ–≥–∏:

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏:
[LOOP] 192.168.1.100 ‚Üí loopMode 2

// –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ UI:
[LOOP-NATIVE] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º 2 –¥–ª—è –≤—Å–µ—Ö –ø–ª–µ–µ—Ä–æ–≤
‚úì WiiM Native Loop –í–ö–õ–Æ–ß–ï–ù –¥–ª—è –≤—Å–µ—Ö –ø–ª–µ–µ—Ä–æ–≤
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –¢—Ä–µ–∫ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- Loop Mode –≤—ã–∫–ª—é—á–µ–Ω (mode = 0)
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç loopmode
- –°–±–æ–π –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –í–∫–ª—é—á–∏—Ç—å Native Loop
window.toggleNativeLoop();

// –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
window.setLoopMode('IP_–ê–î–†–ï–°', 2);
```

### 2. –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –û–±–Ω–æ–≤–∏—Ç—å UI
window.updateLoopModeUI();
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –û—Ç–∫—Ä—ã—Ç—å Network –≤ DevTools
- –ù–∞–π—Ç–∏ –∑–∞–ø—Ä–æ—Å `POST /api/config/loopModes`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 200)

## API Reference

### Frontend API

```javascript
// Loop Mode Service
LoopModeService.toggleNativeLoop()           // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º
LoopModeService.setNativeLoopForAll(mode)    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö
LoopModeService.getNativeLoopState()         // –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
LoopModeService.updateLoopModeUI()           // –û–±–Ω–æ–≤–∏—Ç—å UI

// Players API
PlayersAPI.setLoopMode(playerId, mode)       // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º
```

### Backend API

```
POST /api/players/:ip/loop
Body: { "mode": 2 }
Response: { "success": true }
```

## –ò—Ç–æ–≥

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ WiiM Native Loop —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –ø–ª–µ–µ—Ä–∞–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –†–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 2 (repeat all)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Native Loop** –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º
- –í–∫–ª—é—á–∞–π—Ç–µ —á–µ—Ä–µ–∑ UI –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø–æ–≤—Ç–æ—Ä–æ–º
